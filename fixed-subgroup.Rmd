---
  title: "Plaque psoriasis ML-NMR"
output:
  pdf_document:
  latex_engine: lualatex
fontsize: 12pt
mainfont: Arial
linestretch: 1.5
---
  
  ```{r, include=FALSE, eval=FALSE, echo=FALSE}
# Secukinumab (司库奇尤单抗, Novartis, IL blocker)
# Etanercept (依那西普, Pfizer, TNFa blocker)
# Ustekinumab (乌司奴单抗, J&J, IL blocker)                       
# Ixekizumab (依克珠单抗, EliLilly, IL blocker)

### 5 AGD
1. In the "FIXTURE" trial, the Secukinumab is more effective than Etanercept. (300 mg Secukinumab vs 150 mg Secukinumab vs Placebo vs 50mg etanercept)

2. In the "ERASURE" trial, 300 mg Secukinumab vs 150 mg Secukinumab vs Placebo. 

3. In the "CLEAR" trial, 300 mg Secukinumab vs 150 mg Secukinumab vs Placebo.

4. In the "FEATURE" trial, 300 mg Secukinumab vs 150 mg Secukinumab vs Placebo.

5. In the "JUNCTURE" trial, 300 mg Secukinumab vs 150 mg Secukinumab vs Placebo.

### 4 IPD
1. In the "IXORA" trial, Ixekizumab q2w vs Ustekinumab.

2. In the "UNCOVER-1" trial, 80 mg ixekizumab q2w vs 160 mg ixekizumab q2w vs 80 mg ixekizumab p4w.

3. In the "UNCOVER-2" trial, 80 mg ixekizumab q2w vs 160 mg ixekizumab q2w vs 80 mg ixekizumab p4w vs 50 mg etanercept

4. In the "UNCOVER-3" trial, 80 mg ixekizumab q2w vs 160 mg ixekizumab q2w vs 80 mg ixekizumab p4w vs 50 mg etanercept

5. From the "UNCOVER-2" and "UNCOVER-3", ixekizumab is more effective than Etanercept.

```


```{r, warning=FALSE, echo=FALSE, message=FALSE}

library(multinma)
library(tidyverse)
library(lazyeval)
library(data.table)
library(purrr)
library(kableExtra)
library(rlist) ## save the list as rdata

options(mc.cores = parallel::detectCores())

nc <- switch(tolower(Sys.getenv("_R_CHECK_LIMIT_CORES_")), 
             "true" =, "warn" = 2, 
             parallel::detectCores())
options(mc.cores = nc)
```


## Acquire IPD and AGD
```{r}
sleep_a_minute <- function() { Sys.sleep(10)}

start_time <- Sys.time()
sleep_a_minute()

full_ipd <- plaque_psoriasis_ipd

full_agd <- plaque_psoriasis_agd

```

# Fixed effect model with single subgroup effect
## Age
## check the age distribution of IPD data
```{r, warning=FALSE, echo=FALSE}
hist(full_ipd$age)
summary(full_ipd$age)
```

The distribution is pretty normal. So we take the median as the cutting point of subgroup.

```{r, warning=FALSE}

## Data transformation in IPD
sub_ipd <- full_ipd %>% 
  mutate(# Variable transformations
    bsa = bsa / 100,
    prevsys = as.numeric(prevsys),
    psa = as.numeric(psa),
    weight = weight / 10,
    durnpso = durnpso / 10,
    # Treatment classes
    trtclass = case_when(trtn == 1 ~ "Placebo",
                         trtn %in% c(2, 3, 5, 6, 7) ~ "IL blocker",
                         trtn == 4 ~ "TNFa blocker"),
    # Check complete cases for covariates of interest
    complete = complete.cases(durnpso, prevsys, bsa, weight, psa),
    sub_age = ifelse(age>=47, "gt or eq 47", "lt 47"),
    sub_sex = ifelse(male == "TRUE", 1, 0))


## subgroup result generated from IPD
## five covariate durnpso, prevsys, bsa, weight, psa
## include studyc, trt, trtclass, trtn, trtc_long into by vars

sub_eff_func <- function(group_vars, name_) {
  
  sub_ipd %>% 
    group_by(!!!group_vars) %>%
    summarise(age_mean = mean(age),
              age_sd = sd(age),
              bmi_mean = mean(bmi, na.rm = TRUE),
              bmi_sd = sd(bmi, na.rm = TRUE),
              weight_mean = mean(bmi, na.rm = TRUE),
              weight_sd = sd(bmi, na.rm = TRUE),
              durnpso_mean = mean(durnpso),
              durnpso_sd = sd(durnpso),
              pasi75_n = n(),
              pasi75_r = sum(pasi75),
              pasi90_n = n(),
              pasi90_r = sum(pasi90),
              pasi100_n = n(),
              pasi100_r = sum(pasi100), 
              psa = mean(psa), 
              prevsys = mean(prevsys), 
              bsa_mean = mean(bsa), 
              bsa_sd = sd(bsa)) %>%
    mutate(studyc = paste(studyc, name_)) 
  
}

## aggregrate data age-specific subgroup
agd_sub_age <- sub_eff_func(quos(studyc, trtc, trtclass, trtn, trtc_long, sub_age), "SUB")

## aggregrate data sex-specific subgroup
agd_sub_sex <- sub_eff_func(quos(studyc, trtc, trtclass, trtn, trtc_long, sub_sex), "SUB")

## aggregrate data factorial combination of age and sex subgroup
agd_sub_agesex <- sub_eff_func(quos(studyc, trtc, trtclass, trtn, trtc_long, sub_age, sub_sex), "SUB")

## convert IPD to AgD
ipd_agd <- sub_eff_func(quos(studyc, trtc, trtclass, trtn, trtc_long), "IPD")


## original AgD mutation
sub_agd <- full_agd %>% 
  mutate(
    # Variable transformations
    bsa_mean = bsa_mean / 100,
    bsa_sd = bsa_sd / 100,
    prevsys = prevsys / 100,
    psa = psa / 100,
    weight_mean = weight_mean / 10,
    weight_sd = weight_sd / 10,
    durnpso_mean = durnpso_mean / 10,
    durnpso_sd = durnpso_sd / 10,
    # Treatment classes
    trtclass = case_when(trtn == 1 ~ "Placebo",
                         trtn %in% c(2, 3, 5, 6, 7) ~ "IL blocker",
                         trtn == 4 ~ "TNFa blocker")
  )



## combine AGD with study level/treatment level subgroup
sub_agd1 <- bind_rows(sub_agd,
                      agd_sub_age, 
                      ipd_agd)

sub_agd2 <- bind_rows(sub_agd,
                      agd_sub_sex, 
                      ipd_agd)

sub_agd3 <- bind_rows(sub_agd,
                      agd_sub_agesex, 
                      ipd_agd)

```

A small number of individuals have missing covariates:
  ```{r}
sum(!sub_ipd$complete)
mean(!sub_ipd$complete)
```

Since the proportion of missing data is so small, we will simply exclude these individuals from the analysis.
```{r}
sub_ipd <- filter(sub_ipd, complete)
```

```{r distribution_of_covariates, fig.width=8, fig.height=8, out.width="100%"}
# Get mean and sd of covariates in each study
ipd_summary <- sub_ipd %>% 
  group_by(studyc) %>% 
  summarise_at(vars(weight, durnpso, bsa), list(mean = mean, sd = sd, min = min, max = max)) %>% 
  pivot_longer(weight_mean:bsa_max, names_sep = "_", names_to = c("covariate", ".value")) %>% 
  # Assign distributions
  mutate(dist = recode(covariate,
                       bsa = "dlogitnorm",
                       durnpso = "dgamma",
                       weight = "dgamma")) %>% 
  # Compute density curves
  group_by(studyc, covariate) %>% 
  mutate(value = if_else(dist == "dlogitnorm",
                         list(seq(0, 1, length.out = 101)),
                         list(seq(min*0.8, max*1.2, length.out = 101)))) %>% 
  unnest(cols = value) %>% 
  mutate(dens = eval(call(first(dist), x = value, mean = first(mean), sd = first(sd))))

# Plot histograms and assumed densities
sub_ipd %>% 
  pivot_longer(c(weight, durnpso, bsa), names_to = "covariate", values_to = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram(aes(y = stat(density)), 
                 binwidth = function(x) diff(range(x)) /nclass.Sturges(x),
                 boundary = 0,
                 fill = "grey50") +
  geom_line(aes(y = dens), data = ipd_summary,
            colour = "darkred", size = 0.5) +
  facet_wrap(~studyc + covariate, scales = "free", ncol = 3) +
  theme_multinma()

```

## ML-NMR in different scenario
### Original scenario
```{r, fig.width=8, fig.height=8, out.width="100%"}

## Network of original scenario
## define a function to run the multiple ML-NMRs
## return a list which contains the coefficient of model, network plot, network, and model fit in a list
## agd.dt: the AgD
## col_name: default value is studyc, which helps to select corresponding IPD and AgD
## value1: filter criteria in IPD
## value2: filter cretieria in AgD

func.mult <- function(agd.dt, col_name, value1, value2) {
  
  filter_criteria1 <- interp(~y %in% x, .values=list(y = as.name(col_name), x = value1))
  
  filter_criteria2 <- interp(~y %in% x, .values=list(y = as.name(col_name), x = value2))
  
  net_org <- combine_network(
    set_ipd(sub_ipd %>% filter_(filter_criteria1),
            # set_ipd(sub_ipd,
            study = studyc, 
            trt = trtc, 
            r = pasi75,
            trt_class = trtclass, 
            trt_ref = "PBO"),
    
    set_agd_arm(agd.dt %>% filter_(filter_criteria2), 
                study = studyc, 
                trt = trtc, 
                r = pasi75_r, 
                n = pasi75_n,
                trt_class = trtclass,
                trt_ref = "PBO")
  )
  
  # net_org
  # 
  netplot <- plot(net_org, weight_nodes = T, weight_edges = T, show_trt_class = T) +
    ggplot2::theme(legend.position = "bottom", legend.box = "vertical")
  
  
  ## Add integration points of to the AgD studies in the network
  net_org <- add_integration(net_org,
                             durnpso = distr(qgamma, mean = durnpso_mean, sd = durnpso_sd),
                             prevsys = distr(qbern, prob = prevsys),
                             bsa = distr(qlogitnorm, mean = bsa_mean, sd = bsa_sd),
                             weight = distr(qgamma, mean = weight_mean, sd = weight_sd),
                             psa = distr(qbern, prob = psa),
                             n_int = 1000)
  
  ## fixed effect NL-NMR
  FE_net_org <- nma(net_org, 
                    trt_effects = "fixed",
                    link = "probit", 
                    likelihood = "bernoulli2",
                    regression = ~(durnpso + prevsys + bsa + weight + psa)*.trt,
                    class_interactions = "common",
                    prior_intercept = normal(scale = 10),
                    prior_trt = normal(scale = 10),
                    prior_reg = normal(scale = 10),
                    init_r = 0.1,
                    QR = TRUE)
  
  return(FE_net_org)
  
}

## Original ML-NMR
FE_net_org_df <- func.mult(sub_agd, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE"))


```

func.mult this function would store the coefficient of model, network plot, network, and model fit in a list.

### Adding age-specific subgroup results
```{r, fig.width=8, fig.height=8, out.width="100%"}
#####################################################################
##                        selected IPD is IXORA                    ##
#####################################################################

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_age_agd.sc1.1 <- func.mult(sub_agd1, "studyc", c("UNCOVER-1", "UNCOVER-2", "UNCOVER-3"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "IXORA IPD"))

## 3 IPD + 1 IPD subgrouped + 5 AgD
FE_net_age_agd.sc1.2 <- func.mult(sub_agd1, "studyc", c("UNCOVER-1", "UNCOVER-2", "UNCOVER-3"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "IXORA SUB"))

#####################################################################
##                        selected IPD is UNCOVER-1                ##
#####################################################################

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_age_agd.sc2.1 <- func.mult(sub_agd1, "studyc", c("IXORA", "UNCOVER-2", "UNCOVER-3"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-1 IPD"))

## 3 IPD + 1 IPD subgroup + 5 AgD
FE_net_age_agd.sc2.2 <- func.mult(sub_agd1, "studyc", c("IXORA", "UNCOVER-2", "UNCOVER-3"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-1 SUB"))

#####################################################################
##                        selected IPD is UNCOVER-2                ##
#####################################################################

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_age_agd.sc3.1 <- func.mult(sub_agd1, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-3"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-2 IPD"))

## 3 IPD + 1 IPD subgroup + 5 AgD
FE_net_age_agd.sc3.2 <- func.mult(sub_agd1, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-3"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-2 SUB"))

#####################################################################
##                        selected IPD is UNCOVER-3                ##
#####################################################################

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_age_agd.sc4.1 <- func.mult(sub_agd1, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-2"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-3 IPD"))

## 3 IPD + 1 IPD subgroup + 5 AgD
FE_net_age_agd.sc4.2 <- func.mult(sub_agd1, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-2"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-3 SUB"))


```

```{r pop-up}

# rlist::list.save(FE_net_age_agd.sc1.1, 'FE_net_age_agd_sc1_1.rdata')
# rlist::list.save(FE_net_age_agd.sc1.2, 'FE_net_age_agd_sc1_2.rdata')
# rlist::list.save(FE_net_age_agd.sc2.1, 'FE_net_age_agd_sc2_1.rdata')
# rlist::list.save(FE_net_age_agd.sc2.2, 'FE_net_age_agd_sc2_2.rdata')
# rlist::list.save(FE_net_org_df, 'FE_net_org_df.rdata')

# system('CMD /C "ECHO The R process has finished running && PAUSE"', 
#        invisible=FALSE, wait=FALSE)
```

## Summary

Then in the age subgroup results, we would compare the result of original scenario with model with one IPD aggregated and model with one IPD subgroup result

```{r, warning=FALSE, echo=FALSE, message=FALSE}

## combine coefficients of model in one list
re.list <- list(FE_net_org_df, FE_net_age_agd.sc1.1)

# , FE_net_age_agd.sc1.2, FE_net_age_agd.sc2.1, FE_net_age_agd.sc2.2[[1]], FE_net_age_agd.sc3.1[[1]], FE_net_age_agd.sc3.2[[1]], FE_net_age_agd.sc4.1[[1]], FE_net_age_agd.sc4.2[[1]])

extrac.list <- function (list) {
listof.coeff <- list()
listof.dic <- list()
listof.resd <- list()

for (i in 1:length(re.list)) {
  dt.out <- summary(re.list[[i]], "d", "beta", "mu") %>%
  as_tibble() %>% 
  select(parameter, mean, sd, `2.5%`, `97.5%`) %>%
  mutate_if(is.numeric, round, digits = 3) %>%
  mutate("Mean (95% CI)" = paste0(mean, " (", `2.5%`, ", ", `97.5%`, ")")) %>%
  select(-c(`2.5%`, `97.5%`, mean, sd))

  dt.out$`Mean (95% CI)` <- linebreak(dt.out$`Mean (95% CI)`)

  listof.dic[[i]] <- as.data.frame(dic(re.list[[i]]))
  # listof.resd[[i]] <- dic(re.list[[i]])

  listof.coeff[[i]] <- dt.out
  
}

  comb.list <- list(listof.dic, listof.resd, listof.coeff)
}

xxxx <- as.vector(dic(x))

## merge together
coeff.mod <- do.call("bind_cols", comb.list[[3]])

## remove the redundant variables
coeff.mod <- coeff.mod[,-c(3,5,7,9,11)]

## rename the column name
names(coeff.mod) <- c("par", "org", "ipd_IXORA", "sub_IXORA", "ipd_UNCOVER_1", "sub_UNCOVER_1", "ipd_UNCOVER_2", "sub_UNCOVER_2", "ipd_UNCOVER_3", "sub_UNCOVER_3")

## reorder the columns
coeff.mod <- coeff.mod %>% 
  select(par, org, starts_with("ipd_"), starts_with("sub_"))

## create the latex table
## intercept of different trials
kbl(coeff.mod %>% filter(grepl('mu', par)), booktabs = T, longtable = T, caption = "The Comparisons between Different Scenarios", col.names = c("Parameter", "Original scenario", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3")) %>%
  kable_styling(latex_options = c("striped", "hold_position", "repeat_header"), full_width = T)  %>%
  add_header_above(c(" " = 1, "4 IPD + 5 AgD" = 1, "3 IPD + 1 aggregated IPD + 5 AgD" = 4, "3 IPD + 1 sub-grouped IPD + 5 AgD" = 4))

## coefficients of model
kbl(coeff.mod %>% filter(grepl('beta', par)), booktabs = T, longtable = T, caption = "The Comparisons between Different Scenarios", col.names = c("Parameter", "Original scenario", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3")) %>%
  kable_styling(latex_options = c("striped", "hold_position", "repeat_header"), full_width = T)  %>%
  add_header_above(c(" " = 1, "4 IPD + 5 AgD" = 1, "3 IPD + 1 aggregated IPD + 5 AgD" = 4, "3 IPD + 1 sub-grouped IPD + 5 AgD" = 4))

## treatment difference compared to Placebo
kbl(coeff.mod %>% filter(grepl('^d', par)), booktabs = T, longtable = T, caption = "The Comparisons between Different Scenarios", col.names = c("Parameter", "Original scenario", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3")) %>%
  kable_styling(latex_options = c("striped", "hold_position", "repeat_header"), full_width = T)  %>%
  add_header_above(c(" " = 1, "4 IPD + 5 AgD" = 1, "3 IPD + 1 aggregated IPD + 5 AgD" = 4, "3 IPD + 1 sub-grouped IPD + 5 AgD" = 4))

```


```{r, warning=FALSE, echo=FALSE, message=FALSE}
refit.list <- list(FE_net_org_df[[1]][["dic"]], FE_net_age_agd.sc1.1[[1]][["dic"]], FE_net_age_agd.sc1.2[[1]][["dic"]], FE_net_age_agd.sc2.1[[1]][["dic"]], FE_net_age_agd.sc2.2[[1]][["dic"]], FE_net_age_agd.sc3.1[[1]][["dic"]], FE_net_age_agd.sc3.2[[1]][["dic"]], FE_net_age_agd.sc4.1[[1]][["dic"]], FE_net_age_agd.sc4.2[[1]][["dic"]])

refit.list1 <- list(FE_net_org_df[[1]][["resdev"]], FE_net_age_agd.sc1.1[[1]][["resdev"]], FE_net_age_agd.sc1.2[[1]][["resdev"]], FE_net_age_agd.sc2.1[[1]][["resdev"]], FE_net_age_agd.sc2.2[[1]][["resdev"]], FE_net_age_agd.sc3.1[[1]][["resdev"]], FE_net_age_agd.sc3.2[[1]][["resdev"]], FE_net_age_agd.sc4.1[[1]][["resdev"]], FE_net_age_agd.sc4.2[[1]][["resdev"]])

## merge together
coeff.modfit1 <- do.call("bind_cols", listof.dic)
coeff.modfit2 <- do.call("bind_cols", refit.list1)

coeff.modfit <- bind_rows(coeff.modfit2, coeff.modfit1)
coeff.modfit <- bind_cols(c("Residual Deviance", "DIC"), coeff.modfit)

names(coeff.modfit) <- c("Parameter", "org", "ipd_IXORA", "sub_IXORA", "ipd_UNCOVER_1", "sub_UNCOVER_1", "ipd_UNCOVER_2", "sub_UNCOVER_2", "ipd_UNCOVER_3", "sub_UNCOVER_3")

## create the latex table
kbl(coeff.modfit, booktabs = T, longtable = T, caption = "The Model Fit of Different Scenarios", col.names = c("Criteria", "Original scenario", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3")) %>%
  kable_styling(latex_options = c("striped", "hold_position", "repeat_header"), full_width = T)  %>%
  add_header_above(c(" " = 1, "4 IPD + 5 AgD" = 1, "3 IPD + 1 aggregated IPD + 5 AgD" = 4, "3 IPD + 1 sub-grouped IPD + 5 AgD" = 4))


```

### Adding sex-specific subgroup results
```{r sex-specific group, fig.width=8, fig.height=8, out.width="100%", echo=FALSE， eval=FALSE}

## selected IPD is IXORA
## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_sex_agd.sc1.1 <- func.mult(sub_agd2, "studyc", c("UNCOVER-1", "UNCOVER-2", "UNCOVER-3"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "IXORA IPD"))

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_sex_agd.sc1.2 <- func.mult(sub_agd2, "studyc", c("UNCOVER-1", "UNCOVER-2", "UNCOVER-3"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "IXORA SUB"))


## selected IPD is UNCOVER-1

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_sex_agd.sc2.1 <- func.mult(sub_agd2, "studyc", c("IXORA", "UNCOVER-2", "UNCOVER-3"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-1 IPD"))

## 3 IPD + 1 IPD subgroup + 5 AgD
FE_net_sex_agd.sc2.2 <- func.mult(sub_agd2, "studyc", c("IXORA", "UNCOVER-2", "UNCOVER-3"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-1 SUB"))


## selected IPD is UNCOVER-2

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_sex_agd.sc3.1 <- func.mult(sub_agd2, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-3"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-2 IPD"))

## 3 IPD + 1 IPD subgroup + 5 AgD
FE_net_sex_agd.sc3.2 <- func.mult(sub_agd2, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-3"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-2 SUB"))


## selected IPD is UNCOVER-3

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_sex_agd.sc4.1 <- func.mult(sub_agd2, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-2"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-3 IPD"))

## 3 IPD + 1 IPD subgroup + 5 AgD
FE_net_sex_agd.sc4.2 <- func.mult(sub_agd2, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-2"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-3 SUB"))

## combine the model coefficients
coeff.mod.s <- bind_cols(FE_net_org_df[[1]], 
                         FE_net_sex_agd.sc1.1[[1]] #%>% filter(grepl('beta', parameter)) 
                         %>% dplyr::select(-c(parameter)),
                         FE_net_sex_agd.sc1.2[[1]] %>% dplyr::select(-c(parameter)),
                         FE_net_sex_agd.sc2.1[[1]] %>% dplyr::select(-c(parameter)), 
                         FE_net_sex_agd.sc2.2[[1]] %>% dplyr::select(-c(parameter)),
                         FE_net_sex_agd.sc3.1[[1]] %>% dplyr::select(-c(parameter)), 
                         FE_net_sex_agd.sc3.2[[1]] %>% dplyr::select(-c(parameter)),
                         FE_net_sex_agd.sc4.1[[1]] %>% dplyr::select(-c(parameter)), 
                         FE_net_sex_agd.sc4.2[[1]] %>% dplyr::select(-c(parameter))
)

## rename the column name
names(coeff.mod.s) <- c("par", "org", "ipd_IXORA", "sub_IXORA", "ipd_UNCOVER_1", "sub_UNCOVER_1", "ipd_UNCOVER_2", "sub_UNCOVER_2", "ipd_UNCOVER_3", "sub_UNCOVER_3")

## reorder the columns
coeff.mod.s <- coeff.mod.s %>% 
  select(par, org, starts_with("ipd_"), starts_with("sub_"))

## create the latex table
kbl(coeff.mod.s %>% filter(grepl('mu', par)), booktabs = T, longtable = T, caption = "The Comparisons between Different Scenarios", col.names = c("Parameter", "Original scenario", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3")) %>%
  kable_styling(latex_options = c("striped", "hold_position", "repeat_header"), full_width = T)  %>%
  add_header_above(c(" " = 1, "4 IPD + 5 AgD" = 1, "3 IPD + 1 aggregated IPD + 5 AgD" = 4, "3 IPD + 1 sub-grouped IPD + 5 AgD" = 4))

kbl(coeff.mod.s %>% filter(grepl('beta', par)), booktabs = T, longtable = T, caption = "The Comparisons between Different Scenarios", col.names = c("Parameter", "Original scenario", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3")) %>%
  kable_styling(latex_options = c("striped", "hold_position", "repeat_header"), full_width = T)  %>%
  add_header_above(c(" " = 1, "4 IPD + 5 AgD" = 1, "3 IPD + 1 aggregated IPD + 5 AgD" = 4, "3 IPD + 1 sub-grouped IPD + 5 AgD" = 4))

kbl(coeff.mod.s %>% filter(grepl('^d', par)), booktabs = T, longtable = T, caption = "The Comparisons between Different Scenarios", col.names = c("Parameter", "Original scenario", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3")) %>%
  kable_styling(latex_options = c("striped", "hold_position", "repeat_header"), full_width = T)  %>%
  add_header_above(c(" " = 1, "4 IPD + 5 AgD" = 1, "3 IPD + 1 aggregated IPD + 5 AgD" = 4, "3 IPD + 1 sub-grouped IPD + 5 AgD" = 4))

## create table of model fit 

coeff.modfit1.s <- bind_cols(FE_net_org_df[[4]][["dic"]], 
                             FE_net_age_agd.sc1.1[[4]][["dic"]] ,
                             FE_net_age_agd.sc1.2[[4]][["dic"]] ,
                             FE_net_age_agd.sc2.1[[4]][["dic"]] , 
                             FE_net_age_agd.sc2.2[[4]][["dic"]] ,
                             FE_net_age_agd.sc3.1[[4]][["dic"]] , 
                             FE_net_age_agd.sc3.2[[4]][["dic"]] ,
                             FE_net_age_agd.sc4.1[[4]][["dic"]] , 
                             FE_net_age_agd.sc4.2[[4]][["dic"]] 
)

coeff.modfit2.s <- bind_cols(FE_net_org_df[[4]][["resdev"]], 
                             FE_net_age_agd.sc1.1[[4]][["resdev"]] ,
                             FE_net_age_agd.sc1.2[[4]][["resdev"]] ,
                             FE_net_age_agd.sc2.1[[4]][["resdev"]] , 
                             FE_net_age_agd.sc2.2[[4]][["resdev"]] ,
                             FE_net_age_agd.sc3.1[[4]][["resdev"]] , 
                             FE_net_age_agd.sc3.2[[4]][["resdev"]] ,
                             FE_net_age_agd.sc4.1[[4]][["resdev"]] , 
                             FE_net_age_agd.sc4.2[[4]][["resdev"]] 
)

coeff.modfit.s <- bind_rows(coeff.modfit2.s, coeff.modfit1.s)
coeff.modfit.s <- bind_cols(c("Residual Deviance", "DIC"), coeff.modfit.s)

names(coeff.modfit.s) <- c("Parameter", "org", "ipd_IXORA", "sub_IXORA", "ipd_UNCOVER_1", "sub_UNCOVER_1", "ipd_UNCOVER_2", "sub_UNCOVER_2", "ipd_UNCOVER_3", "sub_UNCOVER_3")

## create the latex table
kbl(coeff.modfit.s, booktabs = T, longtable = T, caption = "The Model Fit of Different Scenarios", col.names = c("Criteria", "Original scenario", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3")) %>%
  kable_styling(latex_options = c("striped", "hold_position", "repeat_header"), full_width = T)  %>%
  add_header_above(c(" " = 1, "4 IPD + 5 AgD" = 1, "3 IPD + 1 aggregated IPD + 5 AgD" = 4, "3 IPD + 1 sub-grouped IPD + 5 AgD" = 4))

```


## Relative effects for each study population
```{r, fig.width=8, fig.height=8, out.width="100%", echo=FALSE}

relate.list <- list(FE_net_org_df[[3]], FE_net_age_agd.sc1.1[[3]], FE_net_age_agd.sc1.2[[3]], FE_net_age_agd.sc2.1[[3]], FE_net_age_agd.sc2.2[[3]], FE_net_age_agd.sc3.1[[3]], FE_net_age_agd.sc3.2[[3]], FE_net_age_agd.sc4.1[[3]], FE_net_age_agd.sc4.2[[3]])



```

## age-sex subgroup

```{r, fig.width=8, fig.height=8, out.width="100%", eval=FALSE, echo=FALSE}

## selected IPD is IXORA
## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_agesex_agd.sc1.1 <- func.mult(sub_agd3, "studyc", c("UNCOVER-1", "UNCOVER-2", "UNCOVER-3"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "IXORA IPD"))

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_agesex_agd.sc1.2 <- func.mult(sub_agd3, "studyc", c("UNCOVER-1", "UNCOVER-2", "UNCOVER-3"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "IXORA SUB"))


## selected IPD is UNCOVER-1

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_agesex_agd.sc2.1 <- func.mult(sub_agd3, "studyc", c("IXORA", "UNCOVER-2", "UNCOVER-3"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-1 IPD"))

## 3 IPD + 1 IPD subgroup + 5 AgD
FE_net_agesex_agd.sc2.2 <- func.mult(sub_agd3, "studyc", c("IXORA", "UNCOVER-2", "UNCOVER-3"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-1 SUB"))


## selected IPD is UNCOVER-2

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_agesex_agd.sc3.1 <- func.mult(sub_agd3, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-3"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-2 IPD"))

## 3 IPD + 1 IPD subgroup + 5 AgD
FE_net_agesex_agd.sc3.2 <- func.mult(sub_agd3, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-3"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-2 SUB"))


## selected IPD is UNCOVER-3

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_agesex_agd.sc4.1 <- func.mult(sub_agd3, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-2"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-3 IPD"))

## 3 IPD + 1 IPD subgroup + 5 AgD
FE_net_agesex_agd.sc4.2 <- func.mult(sub_agd3, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-2"), c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-3 SUB"))
```

```{r}
end_time <- Sys.time()


start_time-end_time

```
















