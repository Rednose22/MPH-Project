---
title: "Plaque psoriasis ML-NMR"
geometry: "left=1cm,right=1cm,top=2.5cm,bottom=2.5cm"
output:
  pdf_document:
  latex_engine: lualatex
fontsize: 11pt
mainfont: Arial
linestretch: 1.5
---
  
```{r, include=FALSE, eval=FALSE, echo=FALSE}
# Secukinumab (司库奇尤单抗, Novartis, IL blocker)
# Etanercept (依那西普, Pfizer, TNFa blocker)
# Ustekinumab (乌司奴单抗, J&J, IL blocker)                       
# Ixekizumab (依克珠单抗, EliLilly, IL blocker)

### 5 AGD
1. In the "FIXTURE" trial, the Secukinu

mab is more effective than Etanercept. (300 mg Secukinumab vs 150 mg Secukinumab vs Placebo vs 50mg etanercept)

2. In the "ERASURE" trial, 300 mg Secukinumab vs 150 mg Secukinumab vs Placebo. 

3. In the "CLEAR" trial, 300 mg Secukinumab vs 150 mg Secukinumab vs Placebo.

4. In the "FEATURE" trial, 300 mg Secukinumab vs 150 mg Secukinumab vs Placebo.

5. In the "JUNCTURE" trial, 300 mg Secukinumab vs 150 mg Secukinumab vs Placebo.

### 4 IPD
1. In the "IXORA" trial, Ixekizumab q2w vs Ustekinumab.

2. In the "UNCOVER-1" trial, 80 mg ixekizumab q2w vs 160 mg ixekizumab q2w vs 80 mg ixekizumab p4w.

3. In the "UNCOVER-2" trial, 80 mg ixekizumab q2w vs 160 mg ixekizumab q2w vs 80 mg ixekizumab p4w vs 50 mg etanercept

4. In the "UNCOVER-3" trial, 80 mg ixekizumab q2w vs 160 mg ixekizumab q2w vs 80 mg ixekizumab p4w vs 50 mg etanercept

5. From the "UNCOVER-2" and "UNCOVER-3", ixekizumab is more effective than Etanercept.

```

## Load the library and set up

```{r, warning=FALSE, message=FALSE, error=FALSE, include=FALSE}

library(multinma)
library(tidyverse)
library(lazyeval)
library(data.table)
library(purrr)
library(kableExtra)
library(rlist) ## save the list as rdata
library(stringr)
library(qdapRegex)
library(gridExtra)
library(lemon)

options(mc.cores = parallel::detectCores())

nc <- switch(tolower(Sys.getenv("_R_CHECK_LIMIT_CORES_")), 
             "true" =, "warn" = 2, 
             parallel::detectCores())
options(mc.cores = nc)

setwd("D:\\MPH-Project")
memory.limit(size=40000) # set memory

```


## Import the saved model result
```{r, warning=FALSE, message=FALSE}

start_time <- Sys.time()
Sys.sleep(5)

# extract the name of model result from folder
temp <- list.files(path='D:\\MPH-Project\\', pattern="*.rdata")

## remove the suffix ".rdata"
temp1 <- lapply(temp, function (x) {
    sub(pattern = "(.*)\\..*$", replacement = "\\1", basename(x))
}) %>%
  as.character()

## get the file path
temp.list <- map(temp, function(x) {paste0("D:\\MPH-Project\\", x)})

for (i in 1) {
   temp1[i]<- list.load(temp.list[[i]])
}

FE_net_age_agd.sc1.1 <- list.load(temp.list[[i]])
FE_net_age_agd.sc1.2 <- list.load(temp.list[[i]])
FE_net_age_agd.sc2.1 <- list.load(temp.list[[i]])
FE_net_age_agd.sc2.2 <- list.load(temp.list[[i]])
FE_net_age_agd.sc3.1 <- list.load(temp.list[[i]])
FE_net_age_agd.sc3.2 <- list.load(temp.list[[i]])
FE_net_age_agd.sc4.1 <- list.load(temp.list[[i]])
FE_net_age_agd.sc4.2 <- list.load(temp.list[[i]])

FE_net_org_df <- list.load(temp.list[[i]])

# FE_net_sex_agd.sc1.1 <- list.load(temp.list[[i]])
# FE_net_sex_agd.sc1.2 <- list.load(temp.list[[i]])
# FE_net_sex_agd.sc2.1 <- list.load(temp.list[[i]])
# FE_net_sex_agd.sc2.2 <- list.load(temp.list[[i]])
# FE_net_sex_agd.sc3.1 <- list.load(temp.list[[i]])
# FE_net_sex_agd.sc3.2 <- list.load(temp.list[[i]])
# FE_net_sex_agd.sc4.1 <- list.load(temp.list[[i]])
# FE_net_sex_agd.sc4.2 <- list.load(temp.list[[i]])

```

## redistribution the data to simulate the treatment more effective in younger population
```{r fig.height=10, fig.width=10, message=FALSE, warning=FALSE}
## checking the missing data
full_ipd <- plaque_psoriasis_ipd %>%
  mutate(   # Check complete cases for covariates of interest
    complete = complete.cases(durnpso, prevsys, bsa, weight, psa, age, male))

#
s.comp <- sum(!full_ipd$complete)
mean.comp <- mean(!full_ipd$complete)

# remove the missing data
full_ipd <- filter(full_ipd, complete)

full_agd <- plaque_psoriasis_agd

## initial count by studyc, age group, pasi75 group
full.crs <- full_ipd %>%
  mutate(sub_age = ifelse(age>=47, "gt or eq 47", "lt 47"),
         cat_pas = ifelse(pasi75 == 1, "yes", "no")) %>%
  count(studyc, trtc, cat_pas, sub_age)

## histogram by studyc before redistribution
ggplot(full.crs) +
    geom_bar(aes(x=sub_age, y=n, fill = cat_pas), stat = "identity") +
    facet_wrap(vars(studyc, trtc)) +
    labs(title = "Distribution before simulation by trials, studies")+
    guides(fill=guide_legend(title="PASI75")) +
    xlabs("Age group") +
    ylabs("Frequency")

## nest data
full_ipd.muta <- full_ipd %>%
    group_by(studyc) %>%
    nest()

## create model and then predict the f(pasi75)
full_ipd.muta$data <- map(full_ipd.muta$data, function(df){
  a <- glm(pasi75 ~ age*trtc + bmi*trtc + male*trtc + bsa*trtc + weight*trtc + durnpso*trtc, family = "binomial", data = df, na.action = "na.exclude")
  df %>%
    mutate(lp = predict(a, type = "link"))
})

# Ensures reproducible
set.seed(1234)
full_ipd.muta$data <- map(full_ipd.muta$data, function(df){
  df %>%
    mutate(lp2 = if_else(age < 47 & trtc %in% c("PBO"),  lp - 0.2, lp),
           lp2 = if_else(age < 47 & !trtc %in% c("PBO"), lp2 + 0.2, lp2),
           risk = plogis(lp2),
          ## Next line is stochastic
           pasi75_sim = rbinom(n = length(lp2), size = 1, prob = risk))
})

## Note can also modify so that treatment-age interaction is continuous; here the log-odds of PASI75 goes down by 0.05 per year of age if placebo, and up by the same amount if not placebo; ie a change in log-odds of 0.5 per decade
# full_ipd.muta$data <- map(full_ipd.muta$data, function(df){
#   df %>%
#     mutate(lp2 = if_else(trtc %in% c("PBO"),   lp - 0.05* age, lp),
#                   lp2 = if_else(!trtc %in% c("PBO"),  lp + 0.05*age, lp),
#            risk = plogis(lp2),
#            ## Next line is stochastic
#            pasi75_sim = rbinom(n = length(lp2), size = 1, prob = risk))
# })

full_ipd <- full_ipd.muta %>%
  unnest(data) %>%
  filter(!is.na(pasi75_sim))  ## 6 records with missing PASI75 deleted from data

full.crs2 <- full_ipd %>%
  mutate(cat_pas = ifelse(pasi75_sim == 1, "yes", "no"),
         sub_age = ifelse(age>=47, "gt or eq 47", "lt 47")) %>%
  count(studyc, trtc, cat_pas, sub_age)

## histogram by studyc after redistribution
ggplot(full.crs2) +
    geom_bar(aes(x=sub_age, y=n, fill = cat_pas), stat = "identity") +
    facet_wrap(vars(studyc, trtc)) +
    labs(title = "Distribution after simulation by trials, studies") +
    guides(fill=guide_legend(title="PASI75"))

```
When we compare two plots, we could find the percentage of PASI75=Yes in the younger population would be higher than the elder.

# Fixed effect model with single subgroup effect

```{r, warning=FALSE, message=FALSE}

## Data transformation in IPD
sub_ipd <- full_ipd %>% 
  mutate(# Variable transformations
    bsa = bsa / 100,
    prevsys = as.numeric(prevsys),
    psa = as.numeric(psa),
    weight = weight / 10,
    durnpso = durnpso / 10,
    # Treatment classes
    trtclass = case_when(trtn == 1 ~ "Placebo",
                         trtn %in% c(2, 3, 5, 6, 7) ~ "IL blocker",
                         trtn == 4 ~ "TNFa blocker"),
    sub_age = ifelse(age>=47, "gt or eq 47", "lt 47"),
    sub_sex = ifelse(male == "TRUE", 1, 0))


## subgroup result generated from IPD
## five covariate durnpso, prevsys, bsa, weight, psa
## include studyc, trt, trtclass, trtn, trtc_long into by vars

sub_eff_func <- function(group_vars, name_) {
  
  sub_ipd %>% 
    group_by(!!!group_vars) %>%
    summarise(age_mean = mean(age),
              age_sd = sd(age),
              bmi_mean = mean(bmi, na.rm = TRUE),
              bmi_sd = sd(bmi, na.rm = TRUE),
              weight_mean = mean(bmi, na.rm = TRUE),
              weight_sd = sd(bmi, na.rm = TRUE),
              durnpso_mean = mean(durnpso),
              durnpso_sd = sd(durnpso),
              pasi75_n = n(),
              pasi75_r = sum(pasi75),
              pasi90_n = n(),
              pasi90_r = sum(pasi90),
              pasi100_n = n(),
              pasi100_r = sum(pasi100), 
              psa = mean(psa), 
              prevsys = mean(prevsys), 
              bsa_mean = mean(bsa), 
              bsa_sd = sd(bsa)) %>%
    mutate(studyc = paste(studyc, name_)) 
  
}

## aggregrate data age-specific subgroup
agd_sub_age <- sub_eff_func(quos(studyc, trtc, trtclass, trtn, trtc_long, sub_age), "SUB")

## aggregrate data sex-specific subgroup
agd_sub_sex <- sub_eff_func(quos(studyc, trtc, trtclass, trtn, trtc_long, sub_sex), "SUB")

## aggregrate data factorial combination of age and sex subgroup
agd_sub_agesex <- sub_eff_func(quos(studyc, trtc, trtclass, trtn, trtc_long, sub_age, sub_sex), "SUB")

## convert IPD to AgD
ipd_agd <- sub_eff_func(quos(studyc, trtc, trtclass, trtn, trtc_long), "IPD")


## original AgD mutation
sub_agd <- full_agd %>% 
  mutate(
    # Variable transformations
    bsa_mean = bsa_mean / 100,
    bsa_sd = bsa_sd / 100,
    prevsys = prevsys / 100,
    psa = psa / 100,
    weight_mean = weight_mean / 10,
    weight_sd = weight_sd / 10,
    durnpso_mean = durnpso_mean / 10,
    durnpso_sd = durnpso_sd / 10,
    # Treatment classes
    trtclass = case_when(trtn == 1 ~ "Placebo",
                         trtn %in% c(2, 3, 5, 6, 7) ~ "IL blocker",
                         trtn == 4 ~ "TNFa blocker")
  )



## combine AGD with study level/treatment level subgroup
sub_agd1 <- bind_rows(sub_agd,
                      agd_sub_age, 
                      ipd_agd)

sub_agd2 <- bind_rows(sub_agd,
                      agd_sub_sex, 
                      ipd_agd)

sub_agd3 <- bind_rows(sub_agd,
                      agd_sub_agesex, 
                      ipd_agd)

```

```{r distribution_of_covariates, fig.width=8, fig.height=8, out.width="100%"}
# Get mean and sd of covariates in each study
ipd_summary <- sub_ipd %>% 
  group_by(studyc) %>% 
  summarise_at(vars(weight, durnpso, bsa, age), list(mean = mean, sd = sd, min = min, max = max)) %>% 
  pivot_longer(weight_mean:age_max, names_sep = "_", names_to = c("covariate", ".value")) %>% 
  # Assign distributions
  mutate(dist = recode(covariate,
                       bsa = "dlogitnorm",
                       durnpso = "dgamma",
                       weight = "dgamma",
                       age = "dgamma")) %>% 
  # Compute density curves
  group_by(studyc, covariate) %>% 
  mutate(value = if_else(dist == "dlogitnorm",
                         list(seq(0, 1, length.out = 101)),
                         list(seq(min*0.8, max*1.2, length.out = 101)))) %>% 
  unnest(cols = value) %>% 
  mutate(dens = eval(call(first(dist), x = value, mean = first(mean), sd = first(sd))))

# Plot histograms and assumed densities
sub_ipd %>% 
  pivot_longer(c(weight, durnpso, bsa, age), names_to = "covariate", values_to = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram(aes(y = stat(density)), 
                 binwidth = function(x) diff(range(x)) /nclass.Sturges(x),
                 boundary = 0,
                 fill = "grey50") +
  geom_line(aes(y = dens), data = ipd_summary,
            colour = "darkred", size = 0.5) +
  facet_wrap(~studyc + covariate, scales = "free", ncol = 3) +
  theme_multinma()

```

## ML-NMR in different scenarios
```{r, warning=FALSE, message=FALSE, eval=FALSE}

## define a function to run the multiple ML-NMRs
## return a list contains nmr model
## agd.dt: the AgD
## col_name: default value is studyc, which helps to select corresponding IPD and AgD
## value1: filter criteria in IPD
## value2: filter criteria in AgD

func.mult <- function(agd.dt, col_name, value1, value2) {
  
  filter_criteria1 <- interp(~y %in% x, .values=list(y = as.name(col_name), x = value1))
  
  filter_criteria2 <- interp(~y %in% x, .values=list(y = as.name(col_name), x = value2))
  
  net_org <- combine_network(
    set_ipd(sub_ipd %>% filter_(filter_criteria1),
            # set_ipd(sub_ipd,
            study = studyc, 
            trt = trtc, 
            r = pasi75_sim,
            trt_class = trtclass, 
            trt_ref = "PBO"),
    
    set_agd_arm(agd.dt %>% filter_(filter_criteria2), 
                study = studyc, 
                trt = trtc, 
                r = pasi75_r, 
                n = pasi75_n,
                trt_class = trtclass,
                trt_ref = "PBO")
  )
  
  # net_org
  # 
  netplot <- plot(net_org, weight_nodes = T, weight_edges = T, show_trt_class = T) +
    ggplot2::theme(legend.position = "bottom", legend.box = "vertical")
  
  
  ## Add integration points of to the AgD studies in the network
  net_org <- add_integration(net_org,
                             durnpso = distr(qgamma, mean = durnpso_mean, sd = durnpso_sd),
                             prevsys = distr(qbern, prob = prevsys),
                             bsa = distr(qlogitnorm, mean = bsa_mean, sd = bsa_sd),
                             weight = distr(qgamma, mean = weight_mean, sd = weight_sd),
                             psa = distr(qbern, prob = psa),
                             age = distr(qgamma, mean = age_mean, sd = age_sd),
                             n_int = 1000)
  
  ## fixed effect NL-NMR
  FE_net_org <- nma(net_org, 
                    trt_effects = "fixed",
                    link = "probit", 
                    # likelihood = "bernoulli2",
                    regression = ~(durnpso + prevsys + bsa + weight + psa + age)*.trt,
                    class_interactions = "common",
                    prior_intercept = normal(scale = 10),
                    prior_trt = normal(scale = 10),
                    prior_reg = normal(scale = 10),
                    init_r = 0.1,
                    QR = TRUE)
  
  return(FE_net_org)
  
}


```

func.mult function would store the model of different scenarios.

### Original scenario
```{r, eval=FALSE, message=FALSE, warning=FALSE}
#####################################################################
##                        Original IPD+AGD                         ##
#####################################################################

## 4 IPD + 5 AgD
FE_net_org_df <- func.mult(sub_agd, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3"), 
                           c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE"))

```

### Scenario 1 (3 IPD + 1 aggregated IPD + 5 AGD)
```{r, eval=FALSE, message=FALSE, warning=FALSE}

#####################################################################
##                        selected IPD is IXORA                    ##
#####################################################################

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_age_agd.sc1.1 <- func.mult(sub_agd1, "studyc", c("UNCOVER-1", "UNCOVER-2", "UNCOVER-3"), 
                                  c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "IXORA IPD"))

#####################################################################
##                        selected IPD is UNCOVER-1                ##
#####################################################################

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_age_agd.sc2.1 <- func.mult(sub_agd1, "studyc", c("IXORA", "UNCOVER-2", "UNCOVER-3"), 
                                  c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-1 IPD"))

#####################################################################
##                        selected IPD is UNCOVER-2                ##
#####################################################################

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_age_agd.sc3.1 <- func.mult(sub_agd1, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-3"), 
                                  c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-2 IPD"))

#####################################################################
##                        selected IPD is UNCOVER-3                ##
#####################################################################

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_age_agd.sc4.1 <- func.mult(sub_agd1, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-2"), 
                                  c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-3 IPD"))

```

### Scenario 2 (3 IPD + 1 subgrouped IPD + 5 AGD)
### Age-specific subgroup results

```{r, eval=FALSE, message=FALSE, warning=FALSE}

#####################################################################
##                        selected IPD is IXORA                    ##
#####################################################################

## 3 IPD + 1 IPD subgrouped + 5 AgD
FE_net_age_agd.sc1.2 <- func.mult(sub_agd1, "studyc", c("UNCOVER-1", "UNCOVER-2", "UNCOVER-3"), 
                                  c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "IXORA SUB"))

#####################################################################
##                        selected IPD is UNCOVER-1                ##
#####################################################################

## 3 IPD + 1 IPD subgroup + 5 AgD
FE_net_age_agd.sc2.2 <- func.mult(sub_agd1, "studyc", c("IXORA", "UNCOVER-2", "UNCOVER-3"), 
                                  c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-1 SUB"))

#####################################################################
##                        selected IPD is UNCOVER-2                ##
#####################################################################

## 3 IPD + 1 IPD subgroup + 5 AgD
FE_net_age_agd.sc3.2 <- func.mult(sub_agd1, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-3"), 
                                  c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-2 SUB"))

#####################################################################
##                        selected IPD is UNCOVER-3                ##
#####################################################################

## 3 IPD + 1 IPD subgroup + 5 AgD
FE_net_age_agd.sc4.2 <- func.mult(sub_agd1, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-2"), 
                                  c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-3 SUB"))

```

```{r save, eval=FALSE, echo=FALSE, include=FALSE}

rlist::list.save(FE_net_org_df, 'D:\\MPH-Project\\FE_net_org_df.rdata')
rlist::list.save(FE_net_age_agd.sc1.1, 'D:\\MPH-Project\\FE_net_age_agd.sc1.1.rdata')
rlist::list.save(FE_net_age_agd.sc1.2, 'D:\\MPH-Project\\FE_net_age_agd.sc1.2.rdata')
rlist::list.save(FE_net_age_agd.sc2.1, 'D:\\MPH-Project\\FE_net_age_agd.sc2.1.rdata')
rlist::list.save(FE_net_age_agd.sc2.2, 'D:\\MPH-Project\\FE_net_age_agd.sc2.2.rdata')
rlist::list.save(FE_net_age_agd.sc3.1, 'D:\\MPH-Project\\FE_net_age_agd.sc3.1.rdata')
rlist::list.save(FE_net_age_agd.sc3.2, 'D:\\MPH-Project\\FE_net_age_agd.sc3.2.rdata')
rlist::list.save(FE_net_age_agd.sc4.1, 'D:\\MPH-Project\\FE_net_age_agd.sc4.1.rdata')
rlist::list.save(FE_net_age_agd.sc4.2, 'D:\\MPH-Project\\FE_net_age_agd_sc4.2.rdata')

```

## Coefficients of model

Then in the age subgroup results, we would compare the result of original scenario, scenario 1, and scenario 2.

```{r, warning=FALSE, message=FALSE, include=FALSE}

## combine coefficients of model in one list
re.list <- list(FE_net_org_df, FE_net_age_agd.sc1.1, FE_net_age_agd.sc1.2, FE_net_age_agd.sc2.1, FE_net_age_agd.sc2.2, FE_net_age_agd.sc3.1, FE_net_age_agd.sc3.2, FE_net_age_agd.sc4.1, FE_net_age_agd.sc4.2)

extrac.list <- function (list.new) {
listof.coeff <- list()
listof.dic <- list()
listof.resd <- list()
listof.pd <- list()
listof.releff <- list()


for (i in 1:length(list.new)) {
  
  ## coefficient
  dt.out <- summary(list.new[[i]], "d", "beta", "mu") %>%
  as_tibble() %>% 
  select(parameter, mean, sd, `2.5%`, `97.5%`) %>%
  # mutate_if(is.numeric, round, digits = 2) %>%
  rename(lower = `2.5%`, upper = `97.5%`) %>%
  mutate(id = i)

  ## model fit
  mf.out <- dic(list.new[[i]])
  
  dic <- mf.out[["dic"]]
  pd <-  mf.out[["pd"]]
  resd <-  mf.out[["resdev"]]
  ## relative treatment
  # rt_fig <- as.data.frame(relative_effects(list.new[[i]]))
  rt_fig <- relative_effects(list.new[[i]])
 
  listof.coeff[[i]] <- dt.out
  listof.dic[[i]] <- dic
  listof.pd[[i]] <- pd
  listof.resd[[i]] <- resd
  listof.releff[[i]] <- rt_fig

}

  comb.list <- list(listof.coeff, listof.dic, listof.pd, listof.resd, listof.releff)
  return(comb.list)
}

comb.list.age <- extrac.list(re.list)

```

### Tables of model result
```{r, message=FALSE, warning=FALSE, echo=FALSE}

## set the coefficients together
coeff.mod1.f <- do.call("bind_rows", comb.list.age[[1]]) %>%
  mutate(scenario = case_when(id %in% 1 ~ "ipd + agd", 
                              id %in% c(2,4,6,8) ~ "ipd + agg ipd + agd",
                              id %in% c(3,5,7,9) ~ "ipd + sub ipd + agd")) %>%
  group_by(scenario, parameter) %>%
  summarise_at(c("mean", "lower", "upper"), mean) %>%
  mutate_if(is.numeric, round, digits = 3) 

## set the coefficients together for tables
coeff.mod1.t <- coeff.mod1.f %>%
mutate("Mean (95% CI)" = paste0(mean, " (", lower, ", ", upper, ")")) %>%
pivot_wider(id_cols = parameter, names_from = scenario, names_sep = " ", values_from = c(`Mean (95% CI)`)) %>%
  filter(!is.na(`ipd + agd`))

#####################################################################
##     Overall Model information under different scenarios         ##
#####################################################################

kbl(coeff.mod1.t %>% filter(grepl('mu', parameter)) %>% mutate(parameter = substring(parameter, 4, nchar(parameter)-1)), booktabs = T, align = "c",
    caption = "The comparisons of intercept between different scenarios", 
    col.names = c("Intercepts", "4 IPD + 5 AgD", "3 IPD + 1 aggregated IPD + 5 AgD", 
                     "3 IPD + 1 sub-grouped IPD + 5 AgD")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), full_width = T)

## coefficients of model
kbl(coeff.mod1.t %>% filter(grepl('beta', parameter)) %>% mutate(parameter = substring(parameter, 6, nchar(parameter)-1)), booktabs = T, align = "c",
    caption = "The comparisons between different scenarios", 
    col.names = c("Coefficients", "4 IPD + 5 AgD", "3 IPD + 1 aggregated IPD + 5 AgD", 
                     "3 IPD + 1 sub-grouped IPD + 5 AgD")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), full_width = T)

## treatment difference compared to Placebo
kbl(coeff.mod1.t %>% filter(grepl('^d', parameter)) %>% mutate(parameter = substring(parameter, 3, nchar(parameter)-1)), booktabs = T, align = "c",
    caption = "The comparisons of treatment effects between different scenarios", 
    col.names = c("treatment effects", "4 IPD + 5 AgD", "3 IPD + 1 aggregated IPD + 5 AgD", 
                     "3 IPD + 1 sub-grouped IPD + 5 AgD")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), full_width = T)

```


## Forest plot of model results
```{r fig.height=12, fig.width=12}
## forest plot to combine results of different scenarios
coeff.mod.f <- coeff.mod1.f  %>%
  ungroup(parameter) %>%
  mutate("Mean (95% CI)" = paste0(mean, " (", lower, ", ", upper, ")")) %>%
  mutate(paramter = ifelse(grepl('mu', parameter), 
                           substring(parameter, 4, nchar(parameter)-1), 
                    ifelse(grepl('beta', parameter), 
                           substring(parameter, 6, nchar(parameter)-1), 
                           substring(parameter, 3, nchar(parameter)-1)))) %>%
  arrange(parameter, scenario)

coe.forest.fig <- function(filter_1, x1, y1, x2, ypot) {
ggplot(coeff.mod.f %>% filter(grepl(filter_1, parameter)), aes(x = mean, y = parameter, color = factor(scenario))) +
    geom_point(position = position_dodge(width = ypot)) +
  geom_errorbarh(aes(xmax = upper, xmin = lower), height=.1, position = position_dodge(width = ypot)) +
  geom_vline(xintercept=0, color="black", linetype="dashed", alpha=.5) +
  geom_text(aes(x = x2, label = `Mean (95% CI)`), position = position_dodge(width = ypot)) +
  scale_x_continuous(limits = c(x1, y1)) +
  ylab(" ") +
  theme(legend.title = element_blank())
}

## age and interaction
p1 <- coe.forest.fig("age", -0.55, 0.2, -0.4, 0.4)

p1

## weight and interaction
p2 <- coe.forest.fig("weight", -0.7, 0.2, -0.5, 0.4)

## psa and interaction
p3 <- coe.forest.fig("psa", -2, 0.7, -1.5, 0.4)

## prevsys and interaction
p4 <- coe.forest.fig("prevsys", -1.9, 1, -1.4, 0.4)

## durnpso and interaction
p5 <- coe.forest.fig("durnpso", -0.6, 0.3, -0.4, 0.4)

## bsa and interaction
p6 <- coe.forest.fig("bsa", -6, 3, -4.5, 0.4)

grid_arrange_shared_legend(p1, p2, p3, p4, p5, p6, ncol=2, nrow=3, position='bottom')

```

## Comparison of different scenarios by trial
```{r, warning=FALSE, message=FALSE, eval=FALSE, include=FALSE}

#####################################################################
##        Model information under different scenarios              ##
#####################################################################
list.coe.trial <- list()

for (i in 1:length(re.list)) {
  dt.out.t <- summary(re.list[[i]], "d", "beta", "mu") %>%
  as_tibble() %>% 
  select(parameter, mean, sd, `2.5%`, `97.5%`) %>%
  mutate_if(is.numeric, round, digits = 3) %>%
  mutate("Mean (95% CI)" = paste0(mean, " (", `2.5%`, ", ", `97.5%`, ")")) %>%
  select(-c(`2.5%`, `97.5%`, mean, sd))  

  dt.out.t$`Mean (95% CI)` <- linebreak(dt.out.t$`Mean (95% CI)`)

  list.coe.trial[[i]] <- dt.out.t
}

## merge the coefficients together
coeff.mod <- do.call("bind_cols", list.coe.trial)

## remove the redundant variables
coeff.mod <- coeff.mod[,-c(3,5,7,9,11,13,15,17)]

## rename the column name
names(coeff.mod) <- c("par", "org", "ipd_IXORA", "sub_IXORA", "ipd_UNCOVER_1", "sub_UNCOVER_1", 
                      "ipd_UNCOVER_2", "sub_UNCOVER_2", "ipd_UNCOVER_3", "sub_UNCOVER_3")

## reorder the columns
coeff.mod <- coeff.mod %>% 
  select(par, org, starts_with("ipd_"), starts_with("sub_"))

## create the latex table
## intercept of different trials
kbl(coeff.mod %>% filter(grepl('mu', par)) %>% mutate(par = substring(par, 4, nchar(par)-1)), booktabs = T, 
    caption = "The Comparisons between Different Scenarios", 
    col.names = c("study-specific\nIntercept", "Original scenario", "IXORA", "UNCOVER-1", "UNCOVER-2",
                  "UNCOVER-3", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), full_width = T, font_size = 7)  %>%
  add_header_above(c(" " = 1, "4 IPD + 5 AgD" = 1, "3 IPD + 1 aggregated IPD + 5 AgD" = 4, 
                     "3 IPD + 1 sub-grouped IPD + 5 AgD" = 4))

## coefficients of model
kbl(coeff.mod %>% filter(grepl('beta', par)) %>% mutate(par = substring(par, 6, nchar(par)-1)), booktabs = T, 
    caption = "The Comparisons between Different Scenarios", 
    col.names = c("Coefficient", "Original scenario", "IXORA", "UNCOVER-1", "UNCOVER-2",
                  "UNCOVER-3", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), full_width = T, font_size = 7)  %>%
  add_header_above(c(" " = 1, "4 IPD + 5 AgD" = 1, "3 IPD + 1 aggregated IPD + 5 AgD" = 4, 
                     "3 IPD + 1 sub-grouped IPD + 5 AgD" = 4))

## treatment difference compared to Placebo
kbl(coeff.mod %>% filter(grepl('^d', par)) %>% mutate(par = substring(par, 3, nchar(par)-1)), booktabs = T, 
    caption = "The Comparisons between Different Scenarios", 
    col.names = c("Direct\ndifference", "Original scenario", "IXORA", "UNCOVER-1", "UNCOVER-2",
                  "UNCOVER-3", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), full_width = T, font_size = 7)  %>%
  add_header_above(c(" " = 1, "4 IPD + 5 AgD" = 1, "3 IPD + 1 aggregated IPD + 5 AgD" = 4, 
                     "3 IPD + 1 sub-grouped IPD + 5 AgD" = 4))
  
```


```{r, warning=FALSE, message=FALSE, eval=FALSE}
## Model fit by scenarios, trials
## merge together
coeff.modfit1 <- do.call("bind_cols", comb.list.age[[2]])
coeff.modfit2 <- do.call("bind_cols", comb.list.age[[3]])
coeff.modfit3 <- do.call("bind_cols", comb.list.age[[4]])

coeff.modfit <- bind_rows(coeff.modfit2, coeff.modfit1, coeff.modfit3)
coeff.modfit <- bind_cols(c("Residual Deviance", "pD", "DIC"), coeff.modfit)

names(coeff.modfit) <- c("Parameter", "org", "ipd_IXORA", "sub_IXORA", "ipd_UNCOVER_1", "sub_UNCOVER_1", 
                         "ipd_UNCOVER_2", "sub_UNCOVER_2", "ipd_UNCOVER_3", "sub_UNCOVER_3")

## create the latex table
kbl(coeff.modfit, booktabs = T, caption = "The Model Fit of Different Scenarios", 
    col.names = c("Criteria", "Original scenario", "IXORA", "UNCOVER-1", "UNCOVER-2",
                  "UNCOVER-3", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), full_width = T, font_size = 7)  %>%
  add_header_above(c(" " = 1, "4 IPD + 5 AgD" = 1, "3 IPD + 1 aggregated IPD + 5 AgD" = 4, 
                     "3 IPD + 1 sub-grouped IPD + 5 AgD" = 4))


```

## Relative effects for each study population
## 4 IPD + 5 AgD
```{r fig.height=8, fig.width=8, message=FALSE, out.width="100%", eval=FALSE}

# comb.list.age[[4]][1]
# comb.list.age[[4]][2]


# draw the figures of relative effects
releff.dt <- rbindlist(comb.list.age[[4]], idcol="ID") %>%
  arrange(ID, parameter, .study) %>%
  mutate(IDc = case_when(ID == 1 ~ "base case",
                         ID == 2 ~ "Scenario 1",
                         ID == 3 ~ "Scenario 2",
                         ID == 4 ~ "Scenario 3",
                         ID == 5 ~ "Scenario 4",
                         ID == 6 ~ "Scenario 5",
                         ID == 7 ~ "Scenario 6",
                         ID == 8 ~ "Scenario 7",
                         ID == 9 ~ "Scenario 8"))

releff.overall <- releff.dt %>%
  mutate(param = trimws(word(ex_bracket(parameter, pattern = "square"), 2, sep=":"))) %>%
  group_by(IDc, param) %>%
  summarise_at(over_mean = mean(mean))

## generate the information in different study
## to present in the title

## get the distinct study
# tem.1 <- releff.dt %>%
#   distinct(.study) %>%
#   arrange(.study)
#
# stdy <- tem.1$.study
#
# stdy <- set_names(stdy)


# reff.fig <- function (x)  {
  # dd <- releff.dt %>% filter(.study == x)
  reff.fig.age <- ggplot(releff.overall) +
  geom_bar(aes(x=IDc, y=over_mean), stat="identity", fill="#124e82", width=0.5) +
  # geom_errorbar(aes(x=IDc, ymin=mean-sd, ymax=mean+sd), width=0.2, colour="#d06d67", size=1) +
  labs(title = "Overall treatment comparison (derived as mean of all specific studies)") +
  xlab("Simulation") +
  ylab("Probit Difference") +
  facet_grid(~param) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
# }

reff.fig.age
# reff.fig.age <- map(stdy, ~reff.fig(.x))

```



## sex-specific subgroup results

```{r sex-specific group, eval=FALSE}

## selected IPD is IXORA
## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_sex_agd.sc1.1 <- func.mult(sub_agd2, "studyc", c("UNCOVER-1", "UNCOVER-2", "UNCOVER-3"), 
                                  c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "IXORA IPD"))

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_sex_agd.sc1.2 <- func.mult(sub_agd2, "studyc", c("UNCOVER-1", "UNCOVER-2", "UNCOVER-3"), 
                                  c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "IXORA SUB"))


## selected IPD is UNCOVER-1

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_sex_agd.sc2.1 <- func.mult(sub_agd2, "studyc", c("IXORA", "UNCOVER-2", "UNCOVER-3"), 
                                  c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-1 IPD"))

## 3 IPD + 1 IPD subgroup + 5 AgD
FE_net_sex_agd.sc2.2 <- func.mult(sub_agd2, "studyc", c("IXORA", "UNCOVER-2", "UNCOVER-3"), 
                                  c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-1 SUB"))


## selected IPD is UNCOVER-2

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_sex_agd.sc3.1 <- func.mult(sub_agd2, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-3"), 
                                  c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-2 IPD"))

## 3 IPD + 1 IPD subgroup + 5 AgD
FE_net_sex_agd.sc3.2 <- func.mult(sub_agd2, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-3"), 
                                  c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-2 SUB"))


## selected IPD is UNCOVER-3

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_sex_agd.sc4.1 <- func.mult(sub_agd2, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-2"), 
                                  c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-3 IPD"))

## 3 IPD + 1 IPD subgroup + 5 AgD
FE_net_sex_agd.sc4.2 <- func.mult(sub_agd2, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-2"), 
                                  c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-3 SUB"))

# rlist::list.save(FE_net_sex_agd.sc1.1, 'FE_net_sex_agd.sc1.1.rdata')
# rlist::list.save(FE_net_sex_agd.sc1.2, 'FE_net_sex_agd.sc1.2.rdata')
# rlist::list.save(FE_net_sex_agd.sc2.1, 'FE_net_sex_agd.sc2.1.rdata')
# rlist::list.save(FE_net_sex_agd.sc2.2, 'FE_net_sex_agd.sc2.2.rdata')
# rlist::list.save(FE_net_sex_agd.sc3.1, 'FE_net_sex_agd.sc3.1.rdata')
# rlist::list.save(FE_net_sex_agd.sc3.2, 'FE_net_sex_agd.sc3.2.rdata')
# rlist::list.save(FE_net_sex_agd.sc4.1, 'FE_net_sex_agd.sc4.1.rdata')
# rlist::list.save(FE_net_sex_agd.sc4.2, 'FE_net_sex_agd.sc4.2.rdata')


```

## Coefficients of model

```{r, fig.width=10, fig.height=10, out.width="100%", message=FALSE, eval=FALSE}
## combine the model coefficients
resex.list <- list(FE_net_org_df, FE_net_sex_agd.sc1.1, FE_net_sex_agd.sc1.2, FE_net_sex_agd.sc2.1, 
                   FE_net_sex_agd.sc2.2, FE_net_sex_agd.sc3.1, FE_net_sex_agd.sc3.2, FE_net_sex_agd.sc4.1, 
                   FE_net_sex_agd.sc4.2)

comb.list.sex <- extrac.list(resex.list)

## merge together
coeff.mod.s <- do.call("bind_cols", comb.list.sex[[1]])

## remove the redundant variables
coeff.mod.s <- coeff.mod.s[,-c(3,5,7,9,11,13,15,17)]

## rename the column name
names(coeff.mod.s) <- c("par", "org", "ipd_IXORA", "sub_IXORA", "ipd_UNCOVER_1", "sub_UNCOVER_1", 
                        "ipd_UNCOVER_2", "sub_UNCOVER_2", "ipd_UNCOVER_3", "sub_UNCOVER_3")

## reorder the columns
coeff.mod.s <- coeff.mod.s %>% 
  select(par, org, starts_with("ipd_"), starts_with("sub_"))

## intercept
kbl(coeff.mod.s %>% filter(grepl('mu', par)) %>% mutate(par = substring(par, 4, nchar(par)-1)), booktabs = T, 
    caption = "The Comparisons between Different Scenarios", 
    col.names = c("Study-specific\nIntercept", "Original scenario", "IXORA", "UNCOVER-1", "UNCOVER-2",
                  "UNCOVER-3", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), full_width = T, font_size = 7)  %>%
  add_header_above(c(" " = 1, "4 IPD + 5 AgD" = 1, "3 IPD + 1 aggregated IPD + 5 AgD" = 4, 
                     "3 IPD + 1 sub-grouped IPD + 5 AgD" = 4))

## coefficients of model
kbl(coeff.mod.s %>% filter(grepl('beta', par)) %>% mutate(par = substring(par, 6, nchar(par)-1)), booktabs = T, 
    caption = "The Comparisons between Different Scenarios", 
    col.names = c("Coefficient", "Original scenario", "IXORA", "UNCOVER-1", "UNCOVER-2",
                  "UNCOVER-3", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), full_width = T, font_size = 7)  %>%
  add_header_above(c(" " = 1, "4 IPD + 5 AgD" = 1, "3 IPD + 1 aggregated IPD + 5 AgD" = 4, 
                     "3 IPD + 1 sub-grouped IPD + 5 AgD" = 4)) %>%
  column_spec(1, width = "2.5cm")

## treatment difference compared to Placebo
kbl(coeff.mod.s %>% filter(grepl('^d', par)) %>% mutate(par = substring(par, 3, nchar(par)-1)), booktabs = T, 
    caption = "The Comparisons between Different Scenarios", 
    col.names = c("Direct\ndifference", "Original scenario", "IXORA", "UNCOVER-1", "UNCOVER-2",
                  "UNCOVER-3", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), full_width = T, font_size = 7)  %>%
  add_header_above(c(" " = 1, "4 IPD + 5 AgD" = 1, "3 IPD + 1 aggregated IPD + 5 AgD" = 4, 
                     "3 IPD + 1 sub-grouped IPD + 5 AgD" = 4))

```

## Model fit

```{r, fig.width=10, fig.height=10, out.width="100%", message=FALSE, eval=FALSE}
## create table of model fit 
coeff.modfit1.s <- do.call("bind_cols", comb.list.sex[[2]])
coeff.modfit2.s <- do.call("bind_cols", comb.list.sex[[3]])

coeff.modfit.s <- bind_rows(coeff.modfit2.s, coeff.modfit1.s)
coeff.modfit.s <- bind_cols(c("Residual Deviance", "DIC"), coeff.modfit.s)

names(coeff.modfit.s) <- c("Parameter", "org", "ipd_IXORA", "sub_IXORA", "ipd_UNCOVER_1", "sub_UNCOVER_1", "ipd_UNCOVER_2", "sub_UNCOVER_2", "ipd_UNCOVER_3", "sub_UNCOVER_3")

## create the latex table
kbl(coeff.modfit.s, booktabs = T, caption = "The Model Fit of Different Scenarios", 
    col.names = c("Criteria", "Original scenario", "IXORA", "UNCOVER-1", "UNCOVER-2",
                  "UNCOVER-3", "IXORA", "UNCOVER-1", "UNCOVER-2", "UNCOVER-3")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), full_width = T, font_size = 7)  %>%
  add_header_above(c(" " = 1, "4 IPD + 5 AgD" = 1, "3 IPD + 1 aggregated IPD + 5 AgD" = 4, 
                     "3 IPD + 1 sub-grouped IPD + 5 AgD" = 4))

```

## relative effect in each study population

```{r, fig.width=8, fig.height=8, out.width="100%", eval=FALSE}

## draw the figures of relative effects
releff.dt.sex <- rbindlist(comb.list.sex[[4]], idcol="ID") %>%
  arrange(.study, parameter, ID) %>%
  mutate(IDc = case_when(ID == 1 ~ "base case",
                         ID == 2 ~ "Scenario 1",
                         ID == 3 ~ "Scenario 2",
                         ID == 4 ~ "Scenario 3",
                         ID == 5 ~ "Scenario 4",
                         ID == 6 ~ "Scenario 5",
                         ID == 7 ~ "Scenario 6",
                         ID == 8 ~ "Scenario 7",
                         ID == 9 ~ "Scenario 8"))


## generate the information in different study 
## to present in the title

## get the distinct study
tem.1 <- releff.dt.sex %>%
  distinct(.study) %>%
  arrange(.study) 

stdy.s <- tem.1$.study

stdy.s <- set_names(stdy.s)


reff.fig.s <- function (x)  {
  dd <- releff.dt.sex %>% filter(.study == x)
  ggplot(dd) +
  geom_bar(aes(x=IDc, y=mean), stat="identity", fill="#124e82", width=0.5) +
  geom_errorbar(aes(x=IDc, ymin=mean-sd, ymax=mean+sd), width=0.2, colour="#d06d67", size=1) +
  labs(title = paste0("Study: ", x)) +
  xlab("Simulation") +
  ylab("Probit Difference") +
  facet_grid(~parameter) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
}


reff.fig.sex <- map(stdy.s, ~reff.fig.s(.x))
reff.fig.sex

```

## age-sex subgroup NOT RUN

```{r, fig.width=8, fig.height=8, out.width="100%", eval=FALSE}

## selected IPD is IXORA
## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_agesex_agd.sc1.1 <- func.mult(sub_agd3, "studyc", c("UNCOVER-1", "UNCOVER-2", "UNCOVER-3"), 
                                     c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "IXORA IPD"))

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_agesex_agd.sc1.2 <- func.mult(sub_agd3, "studyc", c("UNCOVER-1", "UNCOVER-2", "UNCOVER-3"), 
                                     c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "IXORA SUB"))


## selected IPD is UNCOVER-1

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_agesex_agd.sc2.1 <- func.mult(sub_agd3, "studyc", c("IXORA", "UNCOVER-2", "UNCOVER-3"), 
                                     c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-1 IPD"))

## 3 IPD + 1 IPD subgroup + 5 AgD
FE_net_agesex_agd.sc2.2 <- func.mult(sub_agd3, "studyc", c("IXORA", "UNCOVER-2", "UNCOVER-3"), 
                                     c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-1 SUB"))


## selected IPD is UNCOVER-2

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_agesex_agd.sc3.1 <- func.mult(sub_agd3, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-3"), 
                                     c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-2 IPD"))

## 3 IPD + 1 IPD subgroup + 5 AgD
FE_net_agesex_agd.sc3.2 <- func.mult(sub_agd3, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-3"), 
                                     c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-2 SUB"))


## selected IPD is UNCOVER-3

## 3 IPD + 1 IPD aggregated + 5 AgD
FE_net_agesex_agd.sc4.1 <- func.mult(sub_agd3, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-2"), 
                                     c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-3 IPD"))

## 3 IPD + 1 IPD subgroup + 5 AgD
FE_net_agesex_agd.sc4.2 <- func.mult(sub_agd3, "studyc", c("IXORA", "UNCOVER-1", "UNCOVER-2"), 
                                     c("FIXTURE", "ERASURE", "CLEAR", "FEATURE", "JUNCTURE", "UNCOVER-3 SUB"))
```

```{r}
end_time <- Sys.time()

## calculate the running time
start_time-end_time

## pop up notification when it's DONE!
system('CMD /C "ECHO The R process has finished running && PAUSE"',
       invisible=FALSE, wait=FALSE)

```
















